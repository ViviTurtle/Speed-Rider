DROP DATABASE IF EXISTS Speed_Rider;
CREATE DATABASE Speed_Rider;
USE Speed_Rider; 

DROP TABLE IF EXISTS T_CODES;
CREATE TABLE T_CODES(
		CODE_ID CHAR(5) NOT NULL,
        CODE_TYPE VARCHAR(10) NOT NULL,
		CODE_DESCRIPTION VARCHAR(255) NOT NULL,
		CREATED_BY INT,
		CREATED_ON TIMESTAMP DEFAULT CURRENT_TIMESTAMP 
);

DROP TABLE IF EXISTS T_USER;
CREATE TABLE T_USER
(
        USER_ID INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
		USERNAME VARCHAR(32) NOT NULL,
		SALTED_HASH CHAR(64) NOT NULL,
		FNAME VARCHAR(32) NOT NULL,
		LNAME VARCHAR(32) NOT NULL,
		EMAIL VARCHAR(50) NOT NULL,
		PRIM_PHONE CHAR(10) NOT NULL,
		SEC_PHONE CHAR(10),
		USER_TYPE CHAR(5) NOT NULL REFERENCES T_CODES(CODE_ID),
		STATUS_TYPE CHAR(5) NOT NULL REFERENCES T_CODES(CODE_ID),
		CURRENT_LONGITUDE DECIMAL(8,5),
		CURRENT_LATITUDE DECIMAL(8,5)
);

DROP TABLE IF EXISTS T_TRANSANCTION;
CREATE TABLE T_TRANSANCTION
(
		TRANS_ID INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
		CLIENT_ID INT NOT NULL REFERENCES T_USER(USER_ID),
		DRIVER_ID INT  NOT NULL REFERENCES T_USER(USER_ID),
		PICK_UP_LONGITUDE DECIMAL(8,5) NOT NULL,
		PICK_UP_LATITUDE DECIMAL(8,5) NOT NULL,
		DROP_OFF_LONGITUDE DECIMAL(8,5),
		DROP_OFF_LATITUDE DECIMAL(8,5), 
		DRIVER_LONGITUDE DECIMAL(8,5) NOT NULL,
		DRIVER_LATITUDE DECIMAL(8,5) NOT NULL,
		COST DECIMAL(65,2),
		STATUS CHAR(5) NOT NULL REFERENCES T_CODES(CODE_ID),
		CREATED_ON TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
		UPDATED_ON TIMESTAMP
);

ALTER TABLE T_CODES ADD CONSTRAINT FK_USER_TYPE FOREIGN KEY (CREATED_BY) REFERENCES T_USER(USER_ID);

DROP VIEW IF EXISTS V_GET_CLIENTS;
CREATE VIEW V_GET_CLIENTS AS 
SELECT *
FROM T_USER
WHERE USER_TYPE = 'CLIET';

DROP VIEW IF EXISTS V_GET_DRIVERS;
CREATE VIEW V_GET_DRIVERS AS 
SELECT *
FROM T_USER
WHERE USER_TYPE = 'DRIVR';


-- DEFAULT DATA BECAUSE LOAD DATA LOCAL INFILE COMMAND IS NOT WORKING
INSERT INTO T_USER (USERNAME, SALTED_HASH, FNAME, LNAME, EMAIL, PRIM_PHONE, USER_TYPE, STATUS_TYPE)
	VALUES('ViviTurtle','5E0C65E0C65E0C65E0C65E0C65E0C65E0C65E0C65E0C65E0C65E0C65E0C65E01','Vivi','Langga',
		'vivi.langga@gmail.com','4086075657','ADMIN', 'OFFLN'); 

INSERT INTO T_USER (USERNAME, SALTED_HASH, FNAME, LNAME, EMAIL, PRIM_PHONE, USER_TYPE, STATUS_TYPE)
	VALUES('Client1','5E0C65E0C65E0C65E0C65E0C65E0C65E0C65E0C65E0C65E0C65E0C65E0C65E02','William','Wallace',
		'braveheart@gmail.com','4086071234','CLIET', 'OFFLN' ); 

INSERT INTO T_USER (USERNAME, SALTED_HASH, FNAME, LNAME, EMAIL, PRIM_PHONE, USER_TYPE, STATUS_TYPE)
	VALUES('Driver1','5E0C65E0C65E0C65E0C65E0C65E0C65E0C65E0C65E0C65E0C65E0C65E0C65E03','Clark','Kent',
		'superman@gmail.com','4086074321','DRIVR', 'OFFLN' ); 

INSERT INTO T_CODES VALUES ('ADMIN','USER','Adminstrative Users',1, CURRENT_TIMESTAMP);
INSERT INTO T_CODES VALUES ('DRIVR','USER','Drivers',1, CURRENT_TIMESTAMP);
INSERT INTO T_CODES VALUES ('CLIET','USER','Clients',1, CURRENT_TIMESTAMP);
INSERT INTO T_CODES VALUES ('COMPT','T_STATUS','Driver has been paid and Client has been dropped off',1, CURRENT_TIMESTAMP);
INSERT INTO T_CODES VALUES ('IPROG','T_STATUS','Transanction is in-progress',1, CURRENT_TIMESTAMP);
INSERT INTO T_CODES VALUES ('REFUN','T_STATUS','The transanction has been canceled',1, CURRENT_TIMESTAMP);
INSERT INTO T_CODES VALUES ('LFDRV','U_STATUS','Looking for Driver',1, CURRENT_TIMESTAMP);
INSERT INTO T_CODES VALUES ('LFCLT','U_STATUS','Looking for Client',1, CURRENT_TIMESTAMP);
INSERT INTO T_CODES VALUES ('OFFLN','U_STATUS','Offline',1, CURRENT_TIMESTAMP);
INSERT INTO T_CODES VALUES ('HELPD','U_STATUS','Currently being on route',1, CURRENT_TIMESTAMP);



INSERT INTO T_TRANSANCTION (CLIENT_ID, DRIVER_ID, PICK_UP_LONGITUDE, PICK_UP_LATITUDE,DRIVER_LONGITUDE,DRIVER_LATITUDE, COST, STATUS)
	VALUES (2,3,23.23152, 23.23152, 23.23152, 23.23152, 23400.50, 'IPROG');

INSERT INTO T_TRANSANCTION (CLIENT_ID, DRIVER_ID, PICK_UP_LONGITUDE, PICK_UP_LATITUDE,DRIVER_LONGITUDE,DRIVER_LATITUDE, COST, STATUS)
	VALUES (2,3,23.23152,23.23152,23.23152,23.23152, 0, 'IPROG');

INSERT INTO T_TRANSANCTION (CLIENT_ID, DRIVER_ID, PICK_UP_LONGITUDE, PICK_UP_LATITUDE,DRIVER_LONGITUDE,DRIVER_LATITUDE, COST, STATUS)
	VALUES (2,3,23.23152, 23.23152, 23.23152, 23.23152, 240.50, 'IPROG');

UPDATE T_TRANSANCTION
	SET STATUS = 'COMPT', UPDATED_ON = CURRENT_TIMESTAMP
	WHERE TRANS_ID = 1;

UPDATE T_TRANSANCTION
	SET STATUS = 'REFUN', UPDATED_ON = CURRENT_TIMESTAMP
	WHERE TRANS_ID = 3;

